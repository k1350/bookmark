var k="element-p-",L="data-novel-bookmark-id",h="data-novel-bookmark-intersecting";function E({paragraphTag:e="p",...t}){let r=H({...t,paragraphTag:e});return r?()=>r.disconnect():null}function H({wrapperClass:e,paragraphTag:t}){let r=document.getElementsByClassName(e);if(r.length===0)return null;let a=r[0].getElementsByTagName(t);for(let n=0;n<a.length;n++){let i=`${k}${n}`;a[n].dataset.novelBookmarkId=i}let s=new IntersectionObserver(n=>{for(let i of n){let m=i.target;m.dataset.novelBookmarkId&&(m.dataset.novelBookmarkIntersecting=i.isIntersecting.toString())}});for(let n of a)s.observe(n);return s}var b="novel-bookmark-p-id";function F({type:e,key:t,value:r}){return e==="local"?localStorage.setItem(t,r):sessionStorage.setItem(t,r)}function K({type:e,key:t}){return e==="local"?localStorage.getItem(t):sessionStorage.getItem(t)}function q({type:e,key:t}){return e==="local"?localStorage.removeItem(t):sessionStorage.removeItem(t)}function S(e){F({type:"session",key:b,value:e})}function I(){let e=K({type:"session",key:b});return q({type:"session",key:b}),e}function P(){let e=I();if(!e)return;let t=document.querySelector(`[${L}="${e}"]`);t&&t.scrollIntoView({behavior:"smooth"})}var V="novel-bookmarks";var u="novel-bookmarks-store",B;async function $(){return new Promise((e,t)=>{let r=indexedDB.open(V,1);r.onsuccess=function(){B=this.result,e(B)},r.onerror=o=>{t(o)},r.onupgradeneeded=o=>{let a=o.target;if(!a||!("result"in a)){console.error("openDatabase: event.target is invalid",a),t(o);return}let s=a.result;if(!(s instanceof IDBDatabase)){console.error("openDatabase: event.target.result is invalid",s),t(o);return}s.createObjectStore(u,{keyPath:"url"})}})}async function G(){return B||$()}async function g(e){return(await G()).transaction([u],e)}async function x(e){let t=await g("readwrite");return new Promise((r,o)=>{let a=t.objectStore(u).add(e);t.oncomplete=()=>{r()},a.onerror=s=>{o(s)}})}async function w(e){let t=await g("readwrite");return new Promise((r,o)=>{let a=t.objectStore(u).delete(e);t.oncomplete=()=>{r()},a.onerror=s=>{o(s)}})}async function D(e){let t=await g("readonly");return new Promise((r,o)=>{let a=t.objectStore(u).openCursor(),s=[];a.onsuccess=n=>{let i=n.target;if(!i||!("result"in i)){console.error("getAllFromDatabase: event.target is invalid",i),o(n);return}let m=i.result;m instanceof IDBCursorWithValue?e(m.value)?(s.push(m.value),m.continue()):(console.error("getAllFromDatabase: event.target.result.value is invalid",m.value),o(n)):m===null?r(s):(console.error("getAllFromDatabase: event.target.result is invalid",m),o(n))},a.onerror=n=>{o(n)}})}async function A(e,t){let r=await g("readonly");return new Promise((o,a)=>{let s=r.objectStore(u).get(e);s.onsuccess=n=>{let i=n.target;if(!i||!("result"in i)){console.error("getFromDatabase: event.target is invalid",i),a(n);return}let m=i.result;t(m)||m==null?o(m):(console.error("getFromDatabase: event.target.result is invalid",m),a(n))},s.onerror=n=>{a(n)}})}function y(e){return typeof e!="object"||e===null?!1:"title"in e&&typeof e.title=="string"&&"url"in e&&typeof e.url=="string"}async function c(e){return!!await A(e,y)}async function T(){return D(y).catch(e=>(console.error("getBookmarks error",e),[]))}async function C(){if(await c(window.location.href)||(await T()).length>=100)return;let r=Array.from(document.querySelectorAll(`[${h}="true"]`)).map(o=>Number.parseInt(o.dataset.novelBookmarkId?.replace("element-p-","")??"0"));await x({title:document.title,url:window.location.href,id:r.length>0?`${k}${Math.min(...r)}`:void 0}).catch(o=>{console.error("addToDatabase error",o)})}async function v(e){await c(e)&&await w(e)}function _(e){e.id&&S(e.id)}function De(){let e=null;document.readyState!=="loading"?e=E({wrapperClass:"Novel"}):document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&(e=E({wrapperClass:"Novel"}))}),document.readyState==="complete"?P():document.addEventListener("readystatechange",()=>{document.readyState==="complete"&&P()}),window.addEventListener("beforeunload",()=>{e&&(e(),e=null)},!1)}async function p({element:e,bookmarkedText:t="Remove Bookmark",notBookmarkedText:r="Add Bookmark"}){let o=await c(window.location.href);return e.textContent=o?t:r,e.dataset.bookmarked=o?"true":"false",e}async function M({bookmarkedText:e="Remove Bookmark",notBookmarkedText:t="Add Bookmark",onClick:r}){let o=document.createElement("button");return o.type="button",await p({element:o,bookmarkedText:e,notBookmarkedText:t}),o.addEventListener("click",()=>{c(window.location.href).then(a=>{a?v(window.location.href).then(()=>{o.textContent=t,o.dataset.bookmarked="false",r?.()}):C().then(()=>{o.textContent=e,o.dataset.bookmarked="true",r?.()})})}),o}async function O({parentElement:e,className:t,...r}){let o=await M(r);return t&&o.classList.add(t),e.appendChild(o),o}async function d({element:e,noBookmarkText:t="No bookmarks",removeBookmarkButtonText:r="Remove",onClickRemoveBookmarkButton:o}){let a=await T();if(a.length===0){let n=null;for(let i of e.children)i instanceof HTMLUListElement?e.removeChild(i):i instanceof HTMLParagraphElement&&(n=i);return n===null&&(n=document.createElement("p"),e.appendChild(n)),n.textContent=t,e.dataset.empty="true",e}e.dataset.empty="false";let s=null;for(let n of e.children)n instanceof HTMLParagraphElement?e.removeChild(n):n instanceof HTMLUListElement&&(s=n);s===null&&(s=document.createElement("ul"),e.appendChild(s));for(let n of s.children)if(n instanceof HTMLLIElement){let i=n.querySelector("a");if(i instanceof HTMLAnchorElement){let m=i.href;a.some(l=>l.url===m)||s.removeChild(n)}}for(let n of a){let i=n.url;if(!X(i,s)){let m=document.createElement("li"),l=document.createElement("a");l.href=n.url,l.textContent=n.title,l.addEventListener("click",()=>{_(n)});let f=document.createElement("button");f.type="button",f.textContent=r,f.addEventListener("click",()=>{v(n.url).then(()=>{d({element:e,noBookmarkText:t,removeBookmarkButtonText:r}).then(()=>{o?.()})})}),m.appendChild(l),m.appendChild(f),s.appendChild(m)}}return e}function X(e,t){return Array.from(t.children).some(r=>{if(r instanceof HTMLLIElement){let o=r.querySelector("a");if(o instanceof HTMLAnchorElement)return o.href===e}return!1})}async function R(e){let t=document.createElement("div");return await d({element:t,...e}),t}async function N({parentElement:e,className:t,...r}){let o=await R(r);return t&&o.classList.add(t),e.appendChild(o),o}async function We({buttonProps:e,listProps:t}){let r=await O({...e,onClick:()=>j({buttonProps:e,listProps:t})}),o=await N({...t,onClickRemoveBookmarkButton:()=>z({buttonClassName:e.className,...e})});return{button:r,list:o}}function j({buttonProps:{className:e,...t},listProps:{className:r,...o}}){let a=document.querySelector(`.${r}`);a instanceof HTMLDivElement&&d({element:a,...o,onClickRemoveBookmarkButton:()=>{let s=document.querySelector(`.${e}`);s instanceof HTMLButtonElement&&p({element:s,...t})}})}function z({buttonClassName:e,...t}){let r=document.querySelector(`.${e}`);r instanceof HTMLButtonElement&&p({element:r,...t})}export{M as createBookmarkButton,R as createBookmarkList,O as createButton,We as createButtonAndList,N as createList,De as initialize,p as updateBookmarkButton,d as updateBookmarkList};
