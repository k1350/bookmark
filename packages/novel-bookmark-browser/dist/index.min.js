var k="element-p-",P="data-novel-bookmark-id",w="data-novel-bookmark-intersecting";function I({paragraphTag:e="p",...o}){let n=N({...o,paragraphTag:e});return n?()=>n.disconnect():null}function N({wrapperClass:e,paragraphTag:o}){let n=document.getElementsByClassName(e);if(n.length===0)return null;let s=n[0].getElementsByTagName(o);for(let t=0;t<s.length;t++){let m=`${k}${t}`;s[t].dataset.novelBookmarkId=m}let a=new IntersectionObserver(t=>{for(let m of t){let i=m.target;i.dataset.novelBookmarkId&&(i.dataset.novelBookmarkIntersecting=m.isIntersecting.toString())}});for(let t of s)a.observe(t);return a}var S="novel-bookmark-p-id";function R({type:e,key:o,value:n}){return e==="local"?localStorage.setItem(o,n):sessionStorage.setItem(o,n)}function M({type:e,key:o}){return e==="local"?localStorage.getItem(o):sessionStorage.getItem(o)}function F({type:e,key:o}){return e==="local"?localStorage.removeItem(o):sessionStorage.removeItem(o)}function D(e){R({type:"session",key:S,value:e})}function _(){let e=M({type:"session",key:S});return F({type:"session",key:S}),e}function T(){let e=_();if(!e)return;let o=document.querySelector(`[${P}="${e}"]`);o&&o.scrollIntoView({behavior:"smooth"})}var K="novel-bookmarks";var c="novel-bookmarks-store",f;async function V(){return new Promise((e,o)=>{let n=indexedDB.open(K,1);n.onsuccess=function(){f=this.result,e(f)},n.onerror=r=>{o(r)},n.onupgradeneeded=r=>{let s=r.target;if(!s||!("result"in s)){console.error("openDatabase: event.target is invalid",s),o(r);return}let a=s.result;if(!(a instanceof IDBDatabase)){console.error("openDatabase: event.target.result is invalid",a),o(r);return}a.createObjectStore(c,{keyPath:"url"})}})}async function q(){return f||V()}async function g(e){return(await q()).transaction([c],e)}async function h(e){let o=await g("readwrite");return new Promise((n,r)=>{let s=o.objectStore(c).add(e);o.oncomplete=()=>{n()},s.onerror=a=>{r(a)}})}async function x(e){let o=await g("readwrite");return new Promise((n,r)=>{let s=o.objectStore(c).delete(e);o.oncomplete=()=>{n()},s.onerror=a=>{r(a)}})}async function A(e){let o=await g("readonly");return new Promise((n,r)=>{let s=o.objectStore(c).openCursor(),a=[];s.onsuccess=t=>{let m=t.target;if(!m||!("result"in m)){console.error("getAllFromDatabase: event.target is invalid",m),r(t);return}let i=m.result;i instanceof IDBCursorWithValue?e(i.value)?(a.push(i.value),i.continue()):(console.error("getAllFromDatabase: event.target.result.value is invalid",i.value),r(t)):i===null?n(a):(console.error("getAllFromDatabase: event.target.result is invalid",i),r(t))},s.onerror=t=>{r(t)}})}async function O(e,o){let n=await g("readonly");return new Promise((r,s)=>{let a=n.objectStore(c).get(e);a.onsuccess=t=>{let m=t.target;if(!m||!("result"in m)){console.error("getFromDatabase: event.target is invalid",m),s(t);return}let i=m.result;o(i)||i==null?r(i):(console.error("getFromDatabase: event.target.result is invalid",i),s(t))},a.onerror=t=>{s(t)}})}function B(e){return typeof e!="object"||e===null?!1:"title"in e&&typeof e.title=="string"&&"url"in e&&typeof e.url=="string"}async function l(e){return!!await O(e,B)}async function y(){return A(B).catch(e=>(console.error("getBookmarks error",e),[]))}async function L(){if(await l(window.location.href)||(await y()).length>=100)return;let n=Array.from(document.querySelectorAll(`[${w}="true"]`)).map(r=>Number.parseInt(r.dataset.novelBookmarkId?.replace("element-p-","")??"0"));await h({title:document.title,url:window.location.href,id:n.length>0?`${k}${Math.min(...n)}`:void 0}).catch(r=>{console.error("addToDatabase error",r)})}async function b(e){await l(e)&&await x(e)}function C(e){e.id&&D(e.id)}function we(){let e=null;document.readyState!=="loading"?e=I({wrapperClass:"Novel"}):document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&(e=I({wrapperClass:"Novel"}))}),document.readyState==="complete"?T():document.addEventListener("readystatechange",()=>{document.readyState==="complete"&&T()}),window.addEventListener("beforeunload",()=>{e&&(e(),e=null)},!1)}var v="NovelBookmarkButton",E="NovelBookmarkList";async function Ae({parentElement:e=document.body,className:o="NovelBookmarkButton",bookmarkedText:n="Remove Bookmark",notBookmarkedText:r="Add Bookmark",onClick:s}){let a=document.createElement("button");a.type="button",a.id=v,a.classList.add(o);let t=await l(window.location.href);a.textContent=t?n:r,a.dataset.bookmarked=t?"true":"false",a.addEventListener("click",()=>{l(window.location.href).then(m=>{m?b(window.location.href).then(()=>{a.textContent=r,a.dataset.bookmarked="false",s?.()}):L().then(()=>{console.log("bookmarked!"),a.textContent=n,a.dataset.bookmarked="true",s?.()})})}),e.appendChild(a)}async function $({bookmark:e,notBookmarkedText:o="Add Bookmark",...n}){await b(e.url);let r=document.getElementById(v),s=await l(window.location.href);r&&!s&&(r.textContent=o,r.dataset.bookmarked="false"),await X({notBookmarkedText:o,...n})}async function X({parentElement:e=document.body,className:o="NovelBookmarkList",noBookmarkText:n="No bookmarks",removeBookmarkButtonText:r="Remove",...s}){document.getElementById(E)?.remove();let a=await y(),t=document.createElement("div");if(t.id=E,t.classList.add(o),a.length===0){t.textContent=n,t.dataset.empty="true",e.appendChild(t);return}t.dataset.empty="false";let m=document.createElement("ul");for(let i of a){let d=document.createElement("li"),p=document.createElement("a");p.href=i.url,p.textContent=i.title,p.addEventListener("click",()=>{C(i)});let u=document.createElement("button");u.type="button",u.textContent=r,u.addEventListener("click",()=>$({...s,parentElement:e,className:o,noBookmarkText:n,removeBookmarkButtonText:r,bookmark:i})),d.appendChild(p),d.appendChild(u),m.appendChild(d)}t.appendChild(m),e.appendChild(t)}export{Ae as createBookmarkButton,X as createBookmarkList,we as initialize};
