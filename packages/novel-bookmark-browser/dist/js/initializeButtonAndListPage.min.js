var T="novel-bookmark__container",I="novel-bookmark__button",u="novel-bookmark__list-container",L="novel-bookmark__listitem--link";var p="element-p-",v="data-novel-bookmark-id",A="data-novel-bookmark-intersecting";function y({paragraphTag:e="p",...o}){let t=H({...o,paragraphTag:e});return t?()=>t.disconnect():null}function H({wrapperClass:e,paragraphTag:o}){let t=document.getElementsByClassName(e);if(t.length===0)return null;let n=t[0].getElementsByTagName(o);for(let a=0;a<n.length;a++){let s=`${p}${a}`;n[a].dataset.novelBookmarkId=s}let i=new IntersectionObserver(a=>{for(let s of a){let m=s.target;m.dataset.novelBookmarkId&&(m.dataset.novelBookmarkIntersecting=s.isIntersecting.toString())}});for(let a of n)i.observe(a);return i}var _="novel-bookmark-p-id";function V({type:e,key:o,value:t}){return e==="local"?localStorage.setItem(o,t):sessionStorage.setItem(o,t)}function q({type:e,key:o}){return e==="local"?localStorage.getItem(o):sessionStorage.getItem(o)}function G({type:e,key:o}){return e==="local"?localStorage.removeItem(o):sessionStorage.removeItem(o)}function O(e){V({type:"session",key:_,value:e})}function w(){let e=q({type:"session",key:_});return G({type:"session",key:_}),e}function E(){let e=w();if(!e)return;let o=document.querySelector(`[${v}="${e}"]`);o&&o.scrollIntoView({behavior:"smooth"})}var $="novel-bookmarks";var c="novel-bookmarks-store",d;async function z(){return new Promise((e,o)=>{let t=indexedDB.open($,1);t.onsuccess=function(){d=this.result,e(d)},t.onerror=r=>{o(r)},t.onupgradeneeded=r=>{let n=r.target;if(!n||!("result"in n)){console.error("openDatabase: event.target is invalid",n),o(r);return}let i=n.result;if(!(i instanceof IDBDatabase)){console.error("openDatabase: event.target.result is invalid",i),o(r);return}i.createObjectStore(c,{keyPath:"url"})}})}async function U(){return d||z()}async function k(e){return(await U()).transaction([c],e)}async function h(e){let o=await k("readwrite");return new Promise((t,r)=>{let n=o.objectStore(c).add(e);o.oncomplete=()=>{t()},n.onerror=i=>{r(i)}})}async function P(e){let o=await k("readwrite");return new Promise((t,r)=>{let n=o.objectStore(c).delete(e);o.oncomplete=()=>{t()},n.onerror=i=>{r(i)}})}async function M(e){let o=await k("readonly");return new Promise((t,r)=>{let n=o.objectStore(c).openCursor(),i=[];n.onsuccess=a=>{let s=a.target;if(!s||!("result"in s)){console.error("getAllFromDatabase: event.target is invalid",s),r(a);return}let m=s.result;m instanceof IDBCursorWithValue?e(m.value)?(i.push(m.value),m.continue()):(console.error("getAllFromDatabase: event.target.result.value is invalid",m.value),r(a)):m===null?t(i):(console.error("getAllFromDatabase: event.target.result is invalid",m),r(a))},n.onerror=a=>{r(a)}})}async function D(e,o){let t=await k("readonly");return new Promise((r,n)=>{let i=t.objectStore(c).get(e);i.onsuccess=a=>{let s=a.target;if(!s||!("result"in s)){console.error("getFromDatabase: event.target is invalid",s),n(a);return}let m=s.result;o(m)||m==null?r(m):(console.error("getFromDatabase: event.target.result is invalid",m),n(a))},i.onerror=a=>{n(a)}})}function f(e){return typeof e!="object"||e===null?!1:"title"in e&&typeof e.title=="string"&&"url"in e&&typeof e.url=="string"}async function l(e){return!!await D(e,f)}async function g(){return M(f).catch(e=>(console.error("getBookmarks error",e),[]))}async function x(){if(await l(window.location.href)||(await g()).length>=100)return;let t=Array.from(document.querySelectorAll(`[${A}="true"]`)).map(r=>Number.parseInt(r.dataset.novelBookmarkId?.replace("element-p-","")??"0"));await h({title:document.title,url:window.location.href,id:t.length>0?`${p}${Math.min(...t)}`:void 0}).catch(r=>{console.error("addToDatabase error",r)})}async function N(e){await l(e)&&await P(e)}function C(e){e.id&&O(e.id)}function R(){let e=null;document.readyState!=="loading"?e=y({wrapperClass:T}):document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&(e=y({wrapperClass:T}))}),document.readyState==="complete"?E():document.addEventListener("readystatechange",()=>{document.readyState==="complete"&&E()}),window.addEventListener("beforeunload",()=>{e&&(e(),e=null)},!1)}async function K({element:e}){let o=await l(window.location.href);return e.dataset.bookmarked=o?"true":"false",e}async function S({onClick:e}){let o=document.getElementsByClassName(I);if(o.length===0)throw new Error("novel-bookmark__button is not found");let t=o[0];if(!(t instanceof HTMLElement))throw new Error("novel-bookmark__button is not HTMLElement");return await K({element:t}),t.addEventListener("click",()=>{l(window.location.href).then(r=>{r?N(window.location.href).then(()=>{t.dataset.bookmarked="false",e?.()}):x().then(()=>{t.dataset.bookmarked="true",e?.()})})}),t}async function B({element:e}){let o=await g();if(o.length===0)return e.dataset.empty="true",e;e.dataset.empty="false";let t=e.getElementsByTagName("ul");if(t.length===0)throw new Error("ul in novel-bookmark__list-container is not found");let r=t[0];for(let n of r.children)if(n instanceof HTMLLIElement){let i=n.getElementsByTagName("a");if(i.length===0)continue;let a=i[0];if(a instanceof HTMLAnchorElement){let s=a.href;o.some(m=>m.url===s)||r.removeChild(n)}}for(let n of o){let i=n.url;if(!W(i,r)){let a=document.createElement("li"),s=document.createElement("a");s.href=n.url,s.textContent=n.title,s.classList.add(L),s.addEventListener("click",()=>{C(n)}),a.appendChild(s),r.appendChild(a)}}return e}function W(e,o){return Array.from(o.children).some(t=>{if(t instanceof HTMLLIElement){let r=t.getElementsByTagName("a");if(r.length===0)return!1;let n=r[0];if(n instanceof HTMLAnchorElement)return n.href===e}return!1})}async function b(){let e=document.getElementsByClassName(u);if(e.length===0)throw new Error("novel-bookmark__list-container is not found");let o=e[0];if(!(o instanceof HTMLElement))throw new Error("novel-bookmark__list-container is not HTMLElement");return await B({element:o}),o}R();document.readyState!=="loading"?(S({onClick:()=>F()}),b()):document.addEventListener("DOMContentLoaded",()=>{S({onClick:()=>F()}),b()});function F(){let e=document.getElementsByClassName(u);if(e.length===0)throw new Error("novel-bookmark__list-container is not found");let o=e[0];if(!(o instanceof HTMLElement))throw new Error("novel-bookmark__list-container is not HTMLElement");B({element:o})}
