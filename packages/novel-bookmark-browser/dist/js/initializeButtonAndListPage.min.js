var T="novel-bookmark__container",S="novel-bookmark__button",u="novel-bookmark__list-container",b="novel-bookmark__listitem--link";var p="element-p-",I="data-novel-bookmark-id",L="data-novel-bookmark-intersecting";function _({wrapperClass:e}){let o=F({wrapperClass:e});return o?()=>o.disconnect():null}function F({wrapperClass:e}){let o=document.getElementsByClassName(e);if(o.length===0)return null;let t=o[0].children;for(let a=0;a<t.length;a++){let i=`${p}${a}`,s=t[a];s instanceof HTMLElement&&(s.dataset.novelBookmarkId=i)}let n=new IntersectionObserver(a=>{for(let i of a){let s=i.target;!(s instanceof HTMLElement)||!s.dataset.novelBookmarkId||(s.dataset.novelBookmarkIntersecting=i.isIntersecting.toString())}});for(let a of t)n.observe(a);return n}var y="novel-bookmark-p-id";function H({type:e,key:o,value:r}){return e==="local"?localStorage.setItem(o,r):sessionStorage.setItem(o,r)}function V({type:e,key:o}){return e==="local"?localStorage.getItem(o):sessionStorage.getItem(o)}function q({type:e,key:o}){return e==="local"?localStorage.removeItem(o):sessionStorage.removeItem(o)}function v(e){H({type:"session",key:y,value:e})}function A(){let e=V({type:"session",key:y});return q({type:"session",key:y}),e}function E(){let e=A();if(!e)return;let o=document.querySelector(`[${I}="${e}"]`);o&&o.scrollIntoView({behavior:"smooth"})}var G="novel-bookmarks";var c="novel-bookmarks-store",f;async function $(){return new Promise((e,o)=>{let r=indexedDB.open(G,1);r.onsuccess=function(){f=this.result,e(f)},r.onerror=t=>{o(t)},r.onupgradeneeded=t=>{let n=t.target;if(!n||!("result"in n)){console.error("openDatabase: event.target is invalid",n),o(t);return}let a=n.result;if(!(a instanceof IDBDatabase)){console.error("openDatabase: event.target.result is invalid",a),o(t);return}a.createObjectStore(c,{keyPath:"url"})}})}async function z(){return f||$()}async function k(e){return(await z()).transaction([c],e)}async function w(e){let o=await k("readwrite");return new Promise((r,t)=>{let n=o.objectStore(c).add(e);o.oncomplete=()=>{r()},n.onerror=a=>{t(a)}})}async function O(e){let o=await k("readwrite");return new Promise((r,t)=>{let n=o.objectStore(c).delete(e);o.oncomplete=()=>{r()},n.onerror=a=>{t(a)}})}async function h(e){let o=await k("readonly");return new Promise((r,t)=>{let n=o.objectStore(c).openCursor(),a=[];n.onsuccess=i=>{let s=i.target;if(!s||!("result"in s)){console.error("getAllFromDatabase: event.target is invalid",s),t(i);return}let m=s.result;m instanceof IDBCursorWithValue?e(m.value)?(a.push(m.value),m.continue()):(console.error("getAllFromDatabase: event.target.result.value is invalid",m.value),t(i)):m===null?r(a):(console.error("getAllFromDatabase: event.target.result is invalid",m),t(i))},n.onerror=i=>{t(i)}})}async function P(e,o){let r=await k("readonly");return new Promise((t,n)=>{let a=r.objectStore(c).get(e);a.onsuccess=i=>{let s=i.target;if(!s||!("result"in s)){console.error("getFromDatabase: event.target is invalid",s),n(i);return}let m=s.result;o(m)||m==null?t(m):(console.error("getFromDatabase: event.target.result is invalid",m),n(i))},a.onerror=i=>{n(i)}})}function d(e){return typeof e!="object"||e===null?!1:"title"in e&&typeof e.title=="string"&&"url"in e&&typeof e.url=="string"}async function l(e){return!!await P(e,d)}async function g(){return h(d).catch(e=>(console.error("getBookmarks error",e),[]))}async function M(){if(await l(window.location.href)||(await g()).length>=100)return;let r=Array.from(document.querySelectorAll(`[${L}="true"]`)).map(t=>t instanceof HTMLElement?Number.parseInt(t.dataset.novelBookmarkId?.replace("element-p-","")??"0"):0);await w({title:document.title,url:window.location.href,id:r.length>0?`${p}${Math.min(...r)}`:void 0}).catch(t=>{console.error("addToDatabase error",t)})}async function D(e){await l(e)&&await O(e)}function x(e){e.id&&v(e.id)}function N(){let e=null;document.readyState!=="loading"?e=_({wrapperClass:T}):document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&(e=_({wrapperClass:T}))}),document.readyState==="complete"?E():document.addEventListener("readystatechange",()=>{document.readyState==="complete"&&E()}),window.addEventListener("beforeunload",()=>{e&&(e(),e=null)},!1)}async function R({element:e}){let o=await l(window.location.href);return e.dataset.bookmarked=o?"true":"false",e}async function K({onClick:e}){let o=document.getElementsByClassName(S);if(o.length===0)throw new Error("novel-bookmark__button is not found");let r=o[0];if(!(r instanceof HTMLElement))throw new Error("novel-bookmark__button is not HTMLElement");return await R({element:r}),r.addEventListener("click",()=>{l(window.location.href).then(t=>{t?D(window.location.href).then(()=>{r.dataset.bookmarked="false",e?.()}):M().then(()=>{r.dataset.bookmarked="true",e?.()})})}),r}async function B({element:e}){let o=await g();if(o.length===0)return e.dataset.empty="true",e;e.dataset.empty="false";let r=e.getElementsByTagName("ul");if(r.length===0)throw new Error("ul in novel-bookmark__list-container is not found");let t=r[0];for(let n of t.children)if(n instanceof HTMLLIElement){let a=n.getElementsByTagName("a");if(a.length===0)continue;let i=a[0];if(i instanceof HTMLAnchorElement){let s=i.href;o.some(m=>m.url===s)||t.removeChild(n)}}for(let n of o){let a=n.url;if(!X(a,t)){let i=document.createElement("li"),s=document.createElement("a");s.href=n.url,s.textContent=n.title,s.classList.add(b),s.addEventListener("click",()=>{x(n)}),i.appendChild(s),t.appendChild(i)}}return e}function X(e,o){return Array.from(o.children).some(r=>{if(r instanceof HTMLLIElement){let t=r.getElementsByTagName("a");if(t.length===0)return!1;let n=t[0];if(n instanceof HTMLAnchorElement)return n.href===e}return!1})}async function C(){let e=document.getElementsByClassName(u);if(e.length===0)throw new Error("novel-bookmark__list-container is not found");let o=e[0];if(!(o instanceof HTMLElement))throw new Error("novel-bookmark__list-container is not HTMLElement");return await B({element:o}),o}N();K({onClick:()=>{let e=document.getElementsByClassName(u);if(e.length===0)throw new Error("novel-bookmark__list-container is not found");let o=e[0];if(!(o instanceof HTMLElement))throw new Error("novel-bookmark__list-container is not HTMLElement");B({element:o})}});C();
