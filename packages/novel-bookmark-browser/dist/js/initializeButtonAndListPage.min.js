var B="novel-bookmark__container",_="novel-bookmark__button",u="novel-bookmark__list-container",y="novel-bookmark__listitem--link";var p="element-p-",E="data-novel-bookmark-id",b="data-novel-bookmark-intersecting";function S({wrapperClass:o}){let e=F({wrapperClass:o});return e?()=>e.disconnect():null}function F({wrapperClass:o}){let e=document.getElementsByClassName(o);if(e.length===0)return null;let r=e[0].children;for(let a=0;a<r.length;a++){let i=`${p}${a}`,s=r[a];s instanceof HTMLElement&&(s.dataset.novelBookmarkId=i)}let n=new IntersectionObserver(a=>{for(let i of a){let s=i.target;!(s instanceof HTMLElement)||!s.dataset.novelBookmarkId||(s.dataset.novelBookmarkIntersecting=i.isIntersecting.toString())}});for(let a of r)n.observe(a);return n}var T="novel-bookmark-p-id";function H({type:o,key:e,value:t}){return o==="local"?localStorage.setItem(e,t):sessionStorage.setItem(e,t)}function V({type:o,key:e}){return o==="local"?localStorage.getItem(e):sessionStorage.getItem(e)}function q({type:o,key:e}){return o==="local"?localStorage.removeItem(e):sessionStorage.removeItem(e)}function I(o){H({type:"session",key:T,value:o})}function L(){let o=V({type:"session",key:T});return q({type:"session",key:T}),o}function v(){let o=L();if(!o)return;let e=document.querySelector(`[${E}="${o}"]`);e&&e.scrollIntoView({behavior:"smooth"})}var G="novel-bookmarks";var c="novel-bookmarks-store",f;async function $(){return new Promise((o,e)=>{let t=indexedDB.open(G,1);t.onsuccess=function(){f=this.result,o(f)},t.onerror=r=>{e(r)},t.onupgradeneeded=r=>{let n=r.target;if(!n||!("result"in n)){console.error("openDatabase: event.target is invalid",n),e(r);return}let a=n.result;if(!(a instanceof IDBDatabase)){console.error("openDatabase: event.target.result is invalid",a),e(r);return}a.createObjectStore(c,{keyPath:"url"})}})}async function z(){return f||$()}async function k(o){return(await z()).transaction([c],o)}async function A(o){let e=await k("readwrite");return new Promise((t,r)=>{let n=e.objectStore(c).add(o);e.oncomplete=()=>{t()},n.onerror=a=>{r(a)}})}async function w(o){let e=await k("readwrite");return new Promise((t,r)=>{let n=e.objectStore(c).delete(o);e.oncomplete=()=>{t()},n.onerror=a=>{r(a)}})}async function h(o){let e=await k("readonly");return new Promise((t,r)=>{let n=e.objectStore(c).openCursor(),a=[];n.onsuccess=i=>{let s=i.target;if(!s||!("result"in s)){console.error("getAllFromDatabase: event.target is invalid",s),r(i);return}let m=s.result;m instanceof IDBCursorWithValue?o(m.value)?(a.push(m.value),m.continue()):(console.error("getAllFromDatabase: event.target.result.value is invalid",m.value),r(i)):m===null?t(a):(console.error("getAllFromDatabase: event.target.result is invalid",m),r(i))},n.onerror=i=>{r(i)}})}async function O(o,e){let t=await k("readonly");return new Promise((r,n)=>{let a=t.objectStore(c).get(o);a.onsuccess=i=>{let s=i.target;if(!s||!("result"in s)){console.error("getFromDatabase: event.target is invalid",s),n(i);return}let m=s.result;e(m)||m==null?r(m):(console.error("getFromDatabase: event.target.result is invalid",m),n(i))},a.onerror=i=>{n(i)}})}function d(o){return typeof o!="object"||o===null?!1:"title"in o&&typeof o.title=="string"&&"url"in o&&typeof o.url=="string"}async function l(o){return!!await O(o,d)}async function P(){if(await l(window.location.href))return;let e=Array.from(document.querySelectorAll(`[${b}="true"]`)).map(t=>t instanceof HTMLElement?Number.parseInt(t.dataset.novelBookmarkId?.replace("element-p-","")??"0"):0);await A({title:document.title,url:window.location.href,id:e.length>0?`${p}${Math.min(...e)}`:void 0}).catch(t=>{console.error("addToDatabase error",t)})}async function M(o){await l(o)&&await w(o)}function D(o){o.id&&I(o.id)}async function x(){return h(d).catch(o=>(console.error("getBookmarks error",o),[]))}function N(){let o=S({wrapperClass:B});o&&(v(),window.addEventListener("beforeunload",()=>o(),!1))}async function R({element:o}){let e=await l(window.location.href);return o.dataset.bookmarked=e?"true":"false",o}async function C({onClick:o}){let e=document.getElementsByClassName(_);if(e.length===0)throw new Error("novel-bookmark__button is not found");let t=e[0];if(!(t instanceof HTMLElement))throw new Error("novel-bookmark__button is not HTMLElement");return await R({element:t}),t.addEventListener("click",()=>{l(window.location.href).then(r=>{r?M(window.location.href).then(()=>{t.dataset.bookmarked="false",o?.()}):P().then(()=>{t.dataset.bookmarked="true",o?.()})})}),t}async function g({element:o}){let e=await x();if(e.length===0)return o.dataset.empty="true",o;o.dataset.empty="false";let t=o.getElementsByTagName("ul");if(t.length===0)throw new Error("ul in novel-bookmark__list-container is not found");let r=t[0];for(let n of r.children)if(n instanceof HTMLLIElement){let a=n.getElementsByTagName("a");if(a.length===0)continue;let i=a[0];if(i instanceof HTMLAnchorElement){let s=i.href;e.some(m=>m.url===s)||r.removeChild(n)}}for(let n of e){let a=n.url;if(!U(a,r)){let i=document.createElement("li"),s=document.createElement("a");s.href=n.url,s.textContent=n.title,s.classList.add(y),s.addEventListener("click",()=>{D(n)}),i.appendChild(s),r.appendChild(i)}}return o}function U(o,e){return Array.from(e.children).some(t=>{if(t instanceof HTMLLIElement){let r=t.getElementsByTagName("a");if(r.length===0)return!1;let n=r[0];if(n instanceof HTMLAnchorElement)return n.href===o}return!1})}async function K(){let o=document.getElementsByClassName(u);if(o.length===0)throw new Error("novel-bookmark__list-container is not found");let e=o[0];if(!(e instanceof HTMLElement))throw new Error("novel-bookmark__list-container is not HTMLElement");return await g({element:e}),e}N();C({onClick:()=>{let o=document.getElementsByClassName(u);if(o.length===0)throw new Error("novel-bookmark__list-container is not found");let e=o[0];if(!(e instanceof HTMLElement))throw new Error("novel-bookmark__list-container is not HTMLElement");g({element:e})}});K();
