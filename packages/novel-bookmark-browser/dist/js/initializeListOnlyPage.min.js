var b="novel-bookmark-p-id";function S({type:e,key:o,value:n}){return e==="local"?localStorage.setItem(o,n):sessionStorage.setItem(o,n)}function f(e){S({type:"session",key:b,value:e})}var I="novel-bookmarks";var c="novel-bookmarks-store",l;async function v(){return new Promise((e,o)=>{let n=indexedDB.open(I,1);n.onsuccess=function(){l=this.result,e(l)},n.onerror=r=>{o(r)},n.onupgradeneeded=r=>{let t=r.target;if(!t||!("result"in t)){console.error("openDatabase: event.target is invalid",t),o(r);return}let i=t.result;if(!(i instanceof IDBDatabase)){console.error("openDatabase: event.target.result is invalid",i),o(r);return}i.createObjectStore(c,{keyPath:"url"})}})}async function L(){return l||v()}async function A(e){return(await L()).transaction([c],e)}async function d(e){let o=await A("readonly");return new Promise((n,r)=>{let t=o.objectStore(c).openCursor(),i=[];t.onsuccess=a=>{let s=a.target;if(!s||!("result"in s)){console.error("getAllFromDatabase: event.target is invalid",s),r(a);return}let m=s.result;m instanceof IDBCursorWithValue?e(m.value)?(i.push(m.value),m.continue()):(console.error("getAllFromDatabase: event.target.result.value is invalid",m.value),r(a)):m===null?n(i):(console.error("getAllFromDatabase: event.target.result is invalid",m),r(a))},t.onerror=a=>{r(a)}})}function u(e){return typeof e!="object"||e===null?!1:"title"in e&&typeof e.title=="string"&&"url"in e&&typeof e.url=="string"}function k(e){e.id&&f(e.id)}async function g(){return d(u).catch(e=>(console.error("getBookmarks error",e),[]))}var T="novel-bookmark__list-container",_="novel-bookmark__listitem--link";async function y({element:e}){let o=await g();if(o.length===0)return e.dataset.empty="true",e;e.dataset.empty="false";let n=e.getElementsByTagName("ul");if(n.length===0)throw new Error("ul in novel-bookmark__list-container is not found");let r=n[0];for(let t of r.children)if(t instanceof HTMLLIElement){let i=t.getElementsByTagName("a");if(i.length===0)continue;let a=i[0];if(a instanceof HTMLAnchorElement){let s=a.href;o.some(m=>m.url===s)||r.removeChild(t)}}for(let t of o){let i=t.url;if(!P(i,r)){let a=document.createElement("li"),s=document.createElement("a");s.href=t.url,s.textContent=t.title,s.classList.add(_),s.addEventListener("click",()=>{k(t)}),a.appendChild(s),r.appendChild(a)}}return e}function P(e,o){return Array.from(o.children).some(n=>{if(n instanceof HTMLLIElement){let r=n.getElementsByTagName("a");if(r.length===0)return!1;let t=r[0];if(t instanceof HTMLAnchorElement)return t.href===e}return!1})}async function B(){let e=document.getElementsByClassName(T);if(e.length===0)throw new Error("novel-bookmark__list-container is not found");let o=e[0];if(!(o instanceof HTMLElement))throw new Error("novel-bookmark__list-container is not HTMLElement");return await y({element:o}),o}B();
