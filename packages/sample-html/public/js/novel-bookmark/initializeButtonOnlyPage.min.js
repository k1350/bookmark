var u="element-p-",y="data-novel-bookmark-id",T="data-novel-bookmark-intersecting";function k({wrapperClass:e}){let o=M({wrapperClass:e});return o?()=>o.disconnect():null}function M({wrapperClass:e}){let o=document.getElementsByClassName(e);if(o.length===0)return null;let t=o[0].children;for(let n=0;n<t.length;n++){let s=`${u}${n}`,i=t[n];i instanceof HTMLElement&&(i.dataset.novelBookmarkId=s)}let a=new IntersectionObserver(n=>{for(let s of n){let i=s.target;!(i instanceof HTMLElement)||!i.dataset.novelBookmarkId||(i.dataset.novelBookmarkIntersecting=s.isIntersecting.toString())}});for(let n of t)a.observe(n);return a}var S="novel-bookmark-p-id";function L({type:e,key:o}){return e==="local"?localStorage.getItem(o):sessionStorage.getItem(o)}function N({type:e,key:o}){return e==="local"?localStorage.removeItem(o):sessionStorage.removeItem(o)}function _(){let e=L({type:"session",key:S});return N({type:"session",key:S}),e}function g(){let e=_();if(!e)return;let o=document.querySelector(`[${y}="${e}"]`);o&&o.scrollIntoView({behavior:"smooth"})}var R="novel-bookmarks";var c="novel-bookmarks-store",p;async function K(){return new Promise((e,o)=>{let r=indexedDB.open(R,1);r.onsuccess=function(){p=this.result,e(p)},r.onerror=t=>{o(t)},r.onupgradeneeded=t=>{let a=t.target;if(!a||!("result"in a)){console.error("openDatabase: event.target is invalid",a),o(t);return}let n=a.result;if(!(n instanceof IDBDatabase)){console.error("openDatabase: event.target.result is invalid",n),o(t);return}n.createObjectStore(c,{keyPath:"url"})}})}async function C(){return p||K()}async function d(e){return(await C()).transaction([c],e)}async function b(e){let o=await d("readwrite");return new Promise((r,t)=>{let a=o.objectStore(c).add(e);o.oncomplete=()=>{r()},a.onerror=n=>{t(n)}})}async function I(e){let o=await d("readwrite");return new Promise((r,t)=>{let a=o.objectStore(c).delete(e);o.oncomplete=()=>{r()},a.onerror=n=>{t(n)}})}async function v(e){let o=await d("readonly");return new Promise((r,t)=>{let a=o.objectStore(c).openCursor(),n=[];a.onsuccess=s=>{let i=s.target;if(!i||!("result"in i)){console.error("getAllFromDatabase: event.target is invalid",i),t(s);return}let m=i.result;m instanceof IDBCursorWithValue?e(m.value)?(n.push(m.value),m.continue()):(console.error("getAllFromDatabase: event.target.result.value is invalid",m.value),t(s)):m===null?r(n):(console.error("getAllFromDatabase: event.target.result is invalid",m),t(s))},a.onerror=s=>{t(s)}})}async function E(e,o){let r=await d("readonly");return new Promise((t,a)=>{let n=r.objectStore(c).get(e);n.onsuccess=s=>{let i=s.target;if(!i||!("result"in i)){console.error("getFromDatabase: event.target is invalid",i),a(s);return}let m=i.result;o(m)||m==null?t(m):(console.error("getFromDatabase: event.target.result is invalid",m),a(s))},n.onerror=s=>{a(s)}})}function f(e){return typeof e!="object"||e===null?!1:"title"in e&&typeof e.title=="string"&&"url"in e&&typeof e.url=="string"}async function l(e){return!!await E(e,f)}async function A(){return v(f).catch(e=>(console.error("getBookmarks error",e),[]))}async function O(){if(await l(window.location.href)||(await A()).length>=100)return;let r=Array.from(document.querySelectorAll(`[${T}="true"]`)).map(t=>t instanceof HTMLElement?Number.parseInt(t.dataset.novelBookmarkId?.replace("element-p-","")??"0"):0);await b({title:document.title,url:window.location.href,id:r.length>0?`${u}${Math.min(...r)}`:void 0}).catch(t=>{console.error("addToDatabase error",t)})}async function P(e){await l(e)&&await I(e)}var B="novel-bookmark__container",w="novel-bookmark__button";function D(){let e=null;document.readyState!=="loading"?e=k({wrapperClass:B}):document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&(e=k({wrapperClass:B}))}),document.readyState==="complete"?g():document.addEventListener("readystatechange",()=>{document.readyState==="complete"&&g()}),window.addEventListener("beforeunload",()=>{e&&(e(),e=null)},!1)}async function x({element:e}){let o=await l(window.location.href);return e.dataset.bookmarked=o?"true":"false",e}async function h({onClick:e}){let o=document.getElementsByClassName(w);if(o.length===0)throw new Error("novel-bookmark__button is not found");let r=o[0];if(!(r instanceof HTMLElement))throw new Error("novel-bookmark__button is not HTMLElement");return await x({element:r}),r.addEventListener("click",()=>{l(window.location.href).then(t=>{t?P(window.location.href).then(()=>{r.dataset.bookmarked="false",e?.()}):O().then(()=>{r.dataset.bookmarked="true",e?.()})})}),r}D();h({});
