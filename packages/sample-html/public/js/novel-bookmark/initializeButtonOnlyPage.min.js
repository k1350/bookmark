var u="element-p-",T="data-novel-bookmark-id",S="data-novel-bookmark-intersecting";function f({paragraphTag:e="p",...o}){let t=M({...o,paragraphTag:e});return t?()=>t.disconnect():null}function M({wrapperClass:e,paragraphTag:o}){let t=document.getElementsByClassName(e);if(t.length===0)return null;let a=t[0].getElementsByTagName(o);for(let n=0;n<a.length;n++){let m=`${u}${n}`;a[n].dataset.novelBookmarkId=m}let i=new IntersectionObserver(n=>{for(let m of n){let s=m.target;s.dataset.novelBookmarkId&&(s.dataset.novelBookmarkIntersecting=m.isIntersecting.toString())}});for(let n of a)i.observe(n);return i}var _="novel-bookmark-p-id";function L({type:e,key:o}){return e==="local"?localStorage.getItem(o):sessionStorage.getItem(o)}function N({type:e,key:o}){return e==="local"?localStorage.removeItem(o):sessionStorage.removeItem(o)}function b(){let e=L({type:"session",key:_});return N({type:"session",key:_}),e}function g(){let e=b();if(!e)return;let o=document.querySelector(`[${T}="${e}"]`);o&&o.scrollIntoView({behavior:"smooth"})}var R="novel-bookmarks";var c="novel-bookmarks-store",p;async function K(){return new Promise((e,o)=>{let t=indexedDB.open(R,1);t.onsuccess=function(){p=this.result,e(p)},t.onerror=r=>{o(r)},t.onupgradeneeded=r=>{let a=r.target;if(!a||!("result"in a)){console.error("openDatabase: event.target is invalid",a),o(r);return}let i=a.result;if(!(i instanceof IDBDatabase)){console.error("openDatabase: event.target.result is invalid",i),o(r);return}i.createObjectStore(c,{keyPath:"url"})}})}async function C(){return p||K()}async function d(e){return(await C()).transaction([c],e)}async function I(e){let o=await d("readwrite");return new Promise((t,r)=>{let a=o.objectStore(c).add(e);o.oncomplete=()=>{t()},a.onerror=i=>{r(i)}})}async function v(e){let o=await d("readwrite");return new Promise((t,r)=>{let a=o.objectStore(c).delete(e);o.oncomplete=()=>{t()},a.onerror=i=>{r(i)}})}async function E(e){let o=await d("readonly");return new Promise((t,r)=>{let a=o.objectStore(c).openCursor(),i=[];a.onsuccess=n=>{let m=n.target;if(!m||!("result"in m)){console.error("getAllFromDatabase: event.target is invalid",m),r(n);return}let s=m.result;s instanceof IDBCursorWithValue?e(s.value)?(i.push(s.value),s.continue()):(console.error("getAllFromDatabase: event.target.result.value is invalid",s.value),r(n)):s===null?t(i):(console.error("getAllFromDatabase: event.target.result is invalid",s),r(n))},a.onerror=n=>{r(n)}})}async function O(e,o){let t=await d("readonly");return new Promise((r,a)=>{let i=t.objectStore(c).get(e);i.onsuccess=n=>{let m=n.target;if(!m||!("result"in m)){console.error("getFromDatabase: event.target is invalid",m),a(n);return}let s=m.result;o(s)||s==null?r(s):(console.error("getFromDatabase: event.target.result is invalid",s),a(n))},i.onerror=n=>{a(n)}})}function k(e){return typeof e!="object"||e===null?!1:"title"in e&&typeof e.title=="string"&&"url"in e&&typeof e.url=="string"}async function l(e){return!!await O(e,k)}async function A(){return E(k).catch(e=>(console.error("getBookmarks error",e),[]))}async function P(){if(await l(window.location.href)||(await A()).length>=100)return;let t=Array.from(document.querySelectorAll(`[${S}="true"]`)).map(r=>Number.parseInt(r.dataset.novelBookmarkId?.replace("element-p-","")??"0"));await I({title:document.title,url:window.location.href,id:t.length>0?`${u}${Math.min(...t)}`:void 0}).catch(r=>{console.error("addToDatabase error",r)})}async function w(e){await l(e)&&await v(e)}var B="novel-bookmark__container",D="novel-bookmark__button";function x(){let e=null;document.readyState!=="loading"?e=f({wrapperClass:B}):document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&(e=f({wrapperClass:B}))}),document.readyState==="complete"?g():document.addEventListener("readystatechange",()=>{document.readyState==="complete"&&g()}),window.addEventListener("beforeunload",()=>{e&&(e(),e=null)},!1)}async function h({element:e}){let o=await l(window.location.href);return e.dataset.bookmarked=o?"true":"false",e}async function y({onClick:e}){let o=document.getElementsByClassName(D);if(o.length===0)throw new Error("novel-bookmark__button is not found");let t=o[0];if(!(t instanceof HTMLElement))throw new Error("novel-bookmark__button is not HTMLElement");return await h({element:t}),t.addEventListener("click",()=>{l(window.location.href).then(r=>{r?w(window.location.href).then(()=>{t.dataset.bookmarked="false",e?.()}):P().then(()=>{t.dataset.bookmarked="true",e?.()})})}),t}x();document.readyState!=="loading"?y({}):document.addEventListener("DOMContentLoaded",()=>{y({})});
