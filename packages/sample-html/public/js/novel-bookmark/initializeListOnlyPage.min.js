var d="novel-bookmark__list-container",k="novel-bookmark__listitem--link";var S="novel-bookmark-p-id";function I({type:e,key:t,value:n}){return e==="local"?localStorage.setItem(t,n):sessionStorage.setItem(t,n)}function g(e){I({type:"session",key:S,value:e})}var E="novel-bookmarks";var c="novel-bookmarks-store",l;async function b(){return new Promise((e,t)=>{let n=indexedDB.open(E,1);n.onsuccess=function(){l=this.result,e(l)},n.onerror=r=>{t(r)},n.onupgradeneeded=r=>{let o=r.target;if(!o||!("result"in o)){console.error("openDatabase: event.target is invalid",o),t(r);return}let i=o.result;if(!(i instanceof IDBDatabase)){console.error("openDatabase: event.target.result is invalid",i),t(r);return}i.createObjectStore(c,{keyPath:"url"})}})}async function A(){return l||b()}async function v(e){return(await A()).transaction([c],e)}async function T(e){let t=await v("readonly");return new Promise((n,r)=>{let o=t.objectStore(c).openCursor(),i=[];o.onsuccess=a=>{let s=a.target;if(!s||!("result"in s)){console.error("getAllFromDatabase: event.target is invalid",s),r(a);return}let m=s.result;m instanceof IDBCursorWithValue?e(m.value)?(i.push(m.value),m.continue()):(console.error("getAllFromDatabase: event.target.result.value is invalid",m.value),r(a)):m===null?n(i):(console.error("getAllFromDatabase: event.target.result is invalid",m),r(a))},o.onerror=a=>{r(a)}})}function u(e){return typeof e!="object"||e===null?!1:"title"in e&&typeof e.title=="string"&&"url"in e&&typeof e.url=="string"}async function p(){return T(u).catch(e=>(console.error("getBookmarks error",e),[]))}function y(e){e.id&&g(e.id)}async function _({element:e}){let t=await p();if(t.length===0)return e.dataset.empty="true",e;e.dataset.empty="false";let n=e.getElementsByTagName("ul");if(n.length===0)throw new Error("ul in novel-bookmark__list-container is not found");let r=n[0];for(let o of r.children)if(o instanceof HTMLLIElement){let i=o.getElementsByTagName("a");if(i.length===0)continue;let a=i[0];if(a instanceof HTMLAnchorElement){let s=a.href;t.some(m=>m.url===s)||r.removeChild(o)}}for(let o of t){let i=o.url;if(!L(i,r)){let a=document.createElement("li"),s=document.createElement("a");s.href=o.url,s.textContent=o.title,s.classList.add(k),s.addEventListener("click",()=>{y(o)}),a.appendChild(s),r.appendChild(a)}}return e}function L(e,t){return Array.from(t.children).some(n=>{if(n instanceof HTMLLIElement){let r=n.getElementsByTagName("a");if(r.length===0)return!1;let o=r[0];if(o instanceof HTMLAnchorElement)return o.href===e}return!1})}async function f(){let e=document.getElementsByClassName(d);if(e.length===0)throw new Error("novel-bookmark__list-container is not found");let t=e[0];if(!(t instanceof HTMLElement))throw new Error("novel-bookmark__list-container is not HTMLElement");return await _({element:t}),t}document.readyState!=="loading"?f():document.addEventListener("DOMContentLoaded",()=>{f()});
